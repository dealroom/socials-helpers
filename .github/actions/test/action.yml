# Auto-synced file, managed by [dealroom/mothership](https://github.com/dealroom/mothership)
# The changes to this file will be automatically overwritten on the next sync. Do not edit by hand!

# jscpd:ignore-start
name: PHP Test
description: Test the codebase and upload coverage to Code Climate
inputs:
  test-command:
    description: Test command to run
    required: false
    default: vendor/bin/phpunit
  codecov-export:
    description: Whether to enable codecov upload
    required: false
    default: false
    options:
      - true
      - false
  codecov-token:
    description: Codecov token
    required: false
  codecov-coverage-location:
    description: Test coverage location to upload to codecov (required if `codecov-export` input is true)
    required: false
    default: .
  codecov-flags:
    description: Codecov flags to identify this upload (comma-separated)
    required: false
    default: ""
  sonar-token:
    description: SonarQube token (not supported)
    required: false
  working-directory:
    description: Working directory for test execution
    required: false
    default: .
runs:
  using: composite
  steps:
    - shell: sh
      id: coverage-config
      run: |
        COMMAND="${{ inputs.test-command }}"
        if expr "${{ inputs.test-command }}" : ".*phpunit.*" > /dev/null; then
          COMMAND="${COMMAND} --coverage-clover coverage.xml"
        elif expr "${{ inputs.test-command }}" : ".*artisan test.*" > /dev/null; then
          COMMAND="${COMMAND} --coverage-clover=coverage.xml"
        else
          echo "skip_coverage=true" >> "$GITHUB_OUTPUT"
        fi
        echo "command=$COMMAND" >> "$GITHUB_OUTPUT"
    - shell: sh # coverage disabled or skipped, run the raw command
      if: ${{ inputs.codecov-export != 'true' || steps.coverage-config.outputs.skip_coverage == 'true' }}
      run: ${{ inputs.test-command }}
    - shell: sh # codecov coverage enabled, run the command with coverage
      if: ${{ inputs.codecov-export == 'true' && steps.coverage-config.outputs.skip_coverage != 'true' }}
      run: ${{ steps.coverage-config.outputs.command }}
      env:
        XDEBUG_MODE: coverage
    - uses: codecov/codecov-action@5a1091511ad55cbe89839c7260b706298ca349f7 # v5.5.1
      if: ${{ inputs.codecov-export == 'true' && steps.coverage-config.outputs.skip_coverage != 'true' }}
      with:
        directory: ${{ inputs.codecov-coverage-location }}
        token: ${{ inputs.codecov-token }}
# jscpd:ignore-end
