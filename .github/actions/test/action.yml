# Auto-synced file, managed by [dealroom/mothership](https://github.com/dealroom/mothership)
# The changes to this file will be automatically overwritten on the next sync. Do not edit by hand!

# jscpd:ignore-start
name: PHP Test
description: Test the codebase and upload coverage to Code Climate
inputs:
  test-command:
    description: Test command to run
    required: false
    default: vendor/bin/phpunit
  codecov-export:
    description: Whether to enable codecov upload
    required: false
    default: false
  codecov-token:
    description: Codecov token
    required: false
  codecov-coverage-location:
    description: Test coverage location to upload to codecov (required if `codecov-export` input is true)
    required: false
    default: .
  codecov-flags:
    description: Codecov flags to identify this upload (comma-separated)
    required: false
    default: ""
  sonar-token:
    description: SonarQube token (not supported)
    required: false
  working-directory:
    description: Working directory for test execution
    required: false
    default: .
runs:
  using: composite
  steps:
    - shell: sh
      id: coverage-config
      run: |
        COMMAND="${INPUTS_TEST_COMMAND}"
        if expr "${INPUTS_TEST_COMMAND}" : ".*phpunit.*" > /dev/null; then
          COMMAND="${COMMAND} --coverage-clover coverage.xml"
        elif expr "${INPUTS_TEST_COMMAND}" : ".*artisan test.*" > /dev/null; then
          COMMAND="${COMMAND} --coverage-clover=coverage.xml"
        else
          echo "skip_coverage=true" >> "$GITHUB_OUTPUT"
        fi
        echo "command=$COMMAND" >> "$GITHUB_OUTPUT"
      env:
        INPUTS_TEST_COMMAND: ${{ inputs.test-command }}
    - shell: sh # coverage disabled or skipped, run the raw command
      if: ${{ inputs.codecov-export != 'true' || steps.coverage-config.outputs.skip_coverage == 'true' }}
      run: eval "${INPUTS_TEST_COMMAND}"
      env:
        INPUTS_TEST_COMMAND: ${{ inputs.test-command }}
    - shell: sh # codecov coverage enabled, run the command with coverage
      if: ${{ inputs.codecov-export == 'true' && steps.coverage-config.outputs.skip_coverage != 'true' }}
      run: eval "${STEPS_COVERAGE_CONFIG_OUTPUTS_COMMAND}"
      env:
        XDEBUG_MODE: coverage
        STEPS_COVERAGE_CONFIG_OUTPUTS_COMMAND: ${{ steps.coverage-config.outputs.command }}
    - uses: codecov/codecov-action@671740ac38dd9b0130fbe1cec585b89eea48d3de # v5.5.2
      if: ${{ inputs.codecov-export == 'true' && steps.coverage-config.outputs.skip_coverage != 'true' }}
      with:
        directory: ${{ inputs.codecov-coverage-location }}
        token: ${{ inputs.codecov-token }}
# jscpd:ignore-end
