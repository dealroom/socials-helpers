# Auto-synced file, managed by [dealroom/mothership](https://github.com/dealroom/mothership)
# The changes to this file will be automatically overwritten on the next sync. Do not edit by hand!

name: Check Repository Changes
description: Checks if there are any changes in the terraform or charts directory
outputs:
  terraform:
    description: true if there are changes in the terraform directory
    value: ${{ steps.repository-changes.outputs.terraform }}
  charts:
    description: true if there are changes in the charts directory
    value: ${{ steps.repository-changes.outputs.charts }}
  github-only:
    description: true if only .github/ directory files changed
    value: ${{ steps.repository-changes.outputs.github-only }}
runs:
  using: composite
  steps:
    - if: github.event_name == 'release'
      id: last-tag
      uses: WyriHaximus/github-action-get-previous-tag@04e8485ecb6487243907e330d522ff60f02283ce # v1.4.0
    - id: base
      if: github.event_name != 'pull_request'
      # If there is a previous tag, use that as the base
      # Otherwise, use the default branch as the base
      run: |
        if [ "${{ steps.last-tag.outputs.tag }}" != "" ]; then
          NUM_TAGS=2
          TAG=$(git tag --sort=-creatordate | head -n $NUM_TAGS | tail -n 1)
          while [ $(git rev-parse $TAG^{commit}) == ${{ github.sha }} ]; do
            ((NUM_TAGS++))
            TAG=$(git tag --sort=-creatordate | head -n $NUM_TAGS | tail -n 1)
          done
          echo "BASE=$TAG" >> $GITHUB_OUTPUT
          echo "REF=${{ github.ref_name }}" >> $GITHUB_OUTPUT
        else
          echo "BASE=${{ github.event.repository.default_branch }}" >> $GITHUB_OUTPUT
          echo "REF=${{ github.ref }}" >> $GITHUB_OUTPUT
        fi
      shell: bash
    - uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3.0.2
      id: changes
      with:
        filters: |
          terraform:
            - 'terraform/**'
          charts:
            - 'charts/**'
          non-github:
            - '**'
            - '!.github/**'
        base: ${{ steps.base.outputs.BASE }}
        ref: ${{ steps.base.outputs.REF }}
    - id: repository-changes
      run: |
        echo "terraform=${{ steps.changes.outputs.terraform }}" >> $GITHUB_OUTPUT
        echo "charts=${{ steps.changes.outputs.charts }}" >> $GITHUB_OUTPUT

        # Use git to directly check what files changed
        if [ "${{ github.event_name }}" == "pull_request" ]; then
          BASE_REF="${{ github.event.pull_request.base.sha }}"
          HEAD_REF="${{ github.event.pull_request.head.sha }}"
        else
          BASE_REF="${{ steps.base.outputs.BASE }}"
          HEAD_REF="${{ github.sha }}"
        fi

        # Get all changed files
        CHANGED_FILES=$(git diff --name-only ${BASE_REF}...${HEAD_REF} 2>/dev/null || git diff --name-only HEAD^ HEAD 2>/dev/null || echo "")

        # Check if any non-.github files changed
        GITHUB_ONLY=true
        if [ -n "$CHANGED_FILES" ]; then
          while IFS= read -r file; do
            if [[ ! "$file" =~ ^\.github/ ]]; then
              GITHUB_ONLY=false
              break
            fi
          done <<< "$CHANGED_FILES"
        fi

        echo "github-only=$GITHUB_ONLY" >> $GITHUB_OUTPUT
      shell: bash
