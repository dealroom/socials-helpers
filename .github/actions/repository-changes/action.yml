# Auto-synced file, managed by [dealroom/mothership](https://github.com/dealroom/mothership)
# The changes to this file will be automatically overwritten on the next sync. Do not edit by hand!

name: Check Repository Changes
description: Checks if there are any changes in the terraform, charts, or only in the .github directory
inputs:
  github-token:
    description: GitHub token for authentication
    required: false
outputs:
  terraform:
    description: true if there are changes in the terraform directory
    value: ${{ steps.filter.outputs.terraform }}
  charts:
    description: true if there are changes in the charts directory
    value: ${{ steps.filter.outputs.charts }}
  github-only:
    description: true if only .github/ directory files changed
    value: ${{ steps.manual-check.outputs.result }}
runs:
  using: composite
  steps:
    - id: get-previous-tag
      if: github.ref_type == 'tag'
      uses: WyriHaximus/github-action-get-previous-tag@04e8485ecb6487243907e330d522ff60f02283ce # v1.4.0
    - if: ${{ inputs.github-token != '' }}
      shell: bash
      run: |
        # Configure git to use the provided token for GitHub operations
        git config --global url."https://x-access-token:${INPUTS_GITHUB_TOKEN}@github.com/".insteadOf "https://github.com/"
      env:
        INPUTS_GITHUB_TOKEN: ${{ inputs.github-token }}
    - id: refs
      shell: bash
      run: |
        if [[ "${GITHUB_EVENT_NAME}" == "pull_request" ]]; then
          # For PRs
          echo "base=" >> "$GITHUB_OUTPUT"  # paths-filter handles PR base automatically
          echo "base_ref=${PR_BASE_SHA}" >> "$GITHUB_OUTPUT"
          echo "head_ref=${PR_HEAD_SHA}" >> "$GITHUB_OUTPUT"
        elif [[ "${GITHUB_REF_TYPE}" == "tag" ]]; then
          # For tags, use the previous tag
          PREVIOUS_TAG="${STEPS_GET_PREVIOUS_TAG_OUTPUTS_TAG}"
          echo "base=${PREVIOUS_TAG}" >> "$GITHUB_OUTPUT"
          echo "base_ref=${PREVIOUS_TAG}" >> "$GITHUB_OUTPUT"
          echo "head_ref=${GITHUB_SHA}" >> "$GITHUB_OUTPUT"
        elif [[ -n "${EVENT_BEFORE}" ]] && [[ "${EVENT_BEFORE}" != "0000000000000000000000000000000000000000" ]]; then
          # For push events with valid before SHA
          echo "base=${EVENT_BEFORE}" >> "$GITHUB_OUTPUT"
          echo "base_ref=${EVENT_BEFORE}" >> "$GITHUB_OUTPUT"
          echo "head_ref=${GITHUB_SHA}" >> "$GITHUB_OUTPUT"
        else
          # For all other events (release, workflow_dispatch, schedule, etc.) or first push
          # Use the default branch as base
          DEFAULT_BRANCH="${REPO_DEFAULT_BRANCH:-main}"
          # For scheduled/workflow_dispatch runs on default branch, use HEAD~1 to compare with previous commit
          if [[ ("${GITHUB_EVENT_NAME}" == "schedule" || "${GITHUB_EVENT_NAME}" == "workflow_dispatch") ]] && [[ "${GITHUB_REF}" == "refs/heads/${DEFAULT_BRANCH}" ]]; then
            # Get the previous commit SHA, or use the default branch if this is the first commit
            if git rev-parse HEAD~1 >/dev/null 2>&1; then
              PREVIOUS_SHA=$(git rev-parse HEAD~1)
              echo "base=${PREVIOUS_SHA}" >> "$GITHUB_OUTPUT"
              echo "base_ref=${PREVIOUS_SHA}" >> "$GITHUB_OUTPUT"
            else
              # First commit on branch - compare against default branch
              echo "base=${DEFAULT_BRANCH}" >> "$GITHUB_OUTPUT"
              echo "base_ref=origin/${DEFAULT_BRANCH}" >> "$GITHUB_OUTPUT"
            fi
          else
            echo "base=${DEFAULT_BRANCH}" >> "$GITHUB_OUTPUT"
            echo "base_ref=origin/${DEFAULT_BRANCH}" >> "$GITHUB_OUTPUT"
          fi
          echo "head_ref=${GITHUB_SHA}" >> "$GITHUB_OUTPUT"
          # Fetch the default branch if needed
          git fetch origin "$DEFAULT_BRANCH:refs/remotes/origin/$DEFAULT_BRANCH" || true
        fi
      env:
        STEPS_GET_PREVIOUS_TAG_OUTPUTS_TAG: ${{ steps.get-previous-tag.outputs.tag }}
        REPO_DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}
        EVENT_BEFORE: ${{ github.event.before }}
        PR_BASE_SHA: ${{ github.event.pull_request.base.sha }}
        PR_HEAD_SHA: ${{ github.event.pull_request.head.sha }}
    - id: filter
      uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3.0.2
      with:
        token: ${{ inputs.github-token }}
        base: ${{ steps.refs.outputs.base }}
        filters: |
          terraform:
            - 'terraform/**'
          charts:
            - 'charts/**'
    - id: manual-check
      shell: bash
      run: |
        BASE_REF="${STEPS_REFS_OUTPUTS_BASE_REF}"
        HEAD_REF="${STEPS_REFS_OUTPUTS_HEAD_REF}"
        # Check if we can create a valid revision range
        if ! git rev-list "${BASE_REF}".."${HEAD_REF}" >/dev/null 2>&1; then
          echo "Cannot create revision range between ${BASE_REF} and ${HEAD_REF}. Using default branch."
          DEFAULT_BRANCH="${REPO_DEFAULT_BRANCH:-main}"
          git fetch origin "$DEFAULT_BRANCH:refs/remotes/origin/$DEFAULT_BRANCH" || true
          BASE_REF="origin/$DEFAULT_BRANCH"
        fi
        if [[ -z "$CHANGED_FILES" ]]; then
          echo "Calculating diff between BASE: ${BASE_REF} and HEAD: ${HEAD_REF}"
          CHANGED_FILES=$(git diff --name-only "${BASE_REF}".."${HEAD_REF}")
        fi
        echo "Files changed:"
        echo "${CHANGED_FILES}"
        if [[ -z "$CHANGED_FILES" ]]; then
          echo "No changed files detected. Setting result to false."
          echo "result=false" >> $GITHUB_OUTPUT
          exit 0
        fi
        IS_GITHUB_ONLY=true
        while IFS= read -r file; do
          if [[ ! "$file" =~ ^\.github/ ]]; then
            echo "Found file outside .github/: '$file'"
            IS_GITHUB_ONLY=false
            break
          fi
        done <<< "$CHANGED_FILES"
        echo "result=${IS_GITHUB_ONLY}" >> $GITHUB_OUTPUT
      env:
        STEPS_REFS_OUTPUTS_BASE_REF: ${{ steps.refs.outputs.base_ref }}
        STEPS_REFS_OUTPUTS_HEAD_REF: ${{ steps.refs.outputs.head_ref }}
        REPO_DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}
