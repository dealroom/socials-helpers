# Auto-synced file, managed by [dealroom/mothership](https://github.com/dealroom/mothership)
# The changes to this file will be automatically overwritten on the next sync. Do not edit by hand!

# jscpd:ignore-start
name: Setup PHP
description: Setup PHP, with composer and extensions
inputs:
  github-token:
    description: GitHub token to use for composer
    required: false
  install-language:
    description: Whether to install PHP
    required: false
    default: false
    options:
      - true
      - false
  php-version:
    description: PHP version to install (only valid if `install-language` is true or `extensions` are provided)
    required: false
    default: 8.4
  extensions:
    description: Additional PHP extensions to install (comma separated, e.g. `gd,imagick`)
    required: false
    default: none
  docs-generate:
    description: Whether to generate the docs (not implemented)
    required: false
    default: true
    options:
      - true
      - false
  working-directory:
    description: Working directory for Composer commands
    required: false
    default: "."
runs:
  using: composite
  steps:
    - id: extcache
      if: ${{ inputs.extensions != 'none' }}
      uses: shivammathur/cache-extensions@4595bea7d6630821b0a3a4894f816402faaf324c # 1.13.0
      with:
        php-version: ${{ inputs.php-version }}
        extensions: ${{ inputs.extensions }}
        key: ext-cache-1
    - uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
      if: ${{ inputs.extensions != 'none' }}
      with:
        path: ${{ steps.extcache.outputs.dir }}
        key: ${{ steps.extcache.outputs.key }}
        restore-keys: ${{ steps.extcache.outputs.key }}
    - uses: shivammathur/setup-php@bf6b4fbd49ca58e4608c9c89fba0b8d90bd2a39f # 2.35.5
      if: ${{ inputs.install-language == 'true' || inputs.extensions != 'none' }}
      with:
        php-version: ${{ inputs.php-version }}
        extensions: ${{ inputs.extensions }}
        coverage: xdebug
      env:
        GITHUB_TOKEN: ${{ inputs.github-token }}
        COMPOSER_AUTH: '{"github-oauth":{"github.com":"${{ inputs.github-token }}"}}'
    - uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
      with:
        path: ${{ github.workspace }}/vendor
        key: ${{ runner.os }}-composer-${{ hashFiles('composer.lock', '*/composer.lock') }}
        restore-keys: ${{ runner.os }}-composer-
    - shell: sh
      if: ${{ inputs.github-token != '' }}
      run: |
        composer config --global github-oauth.github.com ${{ inputs.github-token }}
    - shell: sh
      run: |
        # Add vendor/ to .gitignore BEFORE creating it to prevent it from being committed
        # Ensure .gitignore exists and ends with newline
        touch .gitignore
        [ -s .gitignore ] && [ -z "$(tail -c 1 .gitignore)" ] || echo "" >> .gitignore
        if ! grep -q "^vendor/$" .gitignore 2>/dev/null; then
          echo "vendor/" >> .gitignore
        fi
    # install composer dependencies
    - shell: sh
      run: composer install --no-progress --prefer-dist --optimize-autoloader --no-scripts --no-interaction
    # configure .env and .env.testing files (if applicable)
    - shell: sh
      run: |
        if [ -f .env.example ]; then
          cp .env.example .env
        fi
        if [ -f .env.testing.example ]; then
          cp .env.testing.example .env.testing
          # Use valkey for dealroom repo, redis for others
          if [ "${{ github.event.repository.name }}" = "dealroom" ]; then
            echo -e "DB_HOST=mysql\nES_HOST=elasticsearch\nREDIS_HOST=valkey\nRABBITMQ_HOST=rabbitmq" >> .env.testing
          else
            echo -e "DB_HOST=mysql\nES_HOST=elasticsearch\nREDIS_HOST=redis\nRABBITMQ_HOST=rabbitmq" >> .env.testing
          fi
        fi
    # configure Laravel environment (if applicable)
    - shell: sh
      run: |
        if [ -f artisan ]; then
          php artisan key:generate
        fi
    # install npm dependencies (if applicable)
    - shell: sh
      run: |
        if [ -f package.json ]; then
          npm install
          npm run build
        fi

# jscpd:ignore-end
