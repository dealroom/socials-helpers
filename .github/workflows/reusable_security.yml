# Auto-synced file, managed by [dealroom/mothership](https://github.com/dealroom/mothership)
# The changes to this file will be automatically overwritten on the next sync. Do not edit by hand!

name: Reusable Security Scanning

on:
  workflow_call:

permissions:
  contents: read
  pull-requests: write
  id-token: write
  packages: read

jobs:
  checkov:
    name: Checkov IaC Scan
    permissions:
      contents: read
      pull-requests: write
      id-token: write
      packages: read
    uses: ./.github/workflows/reusable_security_checkov.yml
    with:
      soft-fail: false

  trivy:
    name: Trivy Vulnerability Scan
    permissions:
      contents: read
      pull-requests: write
      id-token: write
      packages: read
    uses: ./.github/workflows/reusable_security_trivy.yml
    with:
      severity: CRITICAL,HIGH,MEDIUM
      exit-code: "0"

  kyverno:
    name: Kyverno Policy Check
    permissions:
      contents: read
      pull-requests: write
      id-token: write
      packages: read
    uses: ./.github/workflows/reusable_security_kyverno.yml
    with:
      exit-code: "0"

  security-check-results:
    if: ${{ always() }}
    runs-on: ubuntu-latest
    name: Security Checks Result
    needs: [checkov, trivy, kyverno]
    permissions:
      contents: read
    steps:
      - name: Checkout Repository
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          persist-credentials: false
      - name: Aggregate Security Results
        uses: ./.github/actions/test-results
        with:
          needs: ${{ toJson(needs) }}
